<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Imperial Black - Complete Edition</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(to bottom, #87CEEB 0%, #87CEEB 40%, #228B22 40%, #228B22 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Navigation */
        .nav-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-title {
            color: white;
            font-size: 18px;
            font-weight: bold;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
        }

        .nav-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .nav-btn.active {
            background: #4CAF50;
            color: white;
        }

        .nav-btn:not(.active) {
            background: #666;
            color: white;
        }

        .nav-btn:hover {
            transform: scale(1.05);
        }

        /* Screens */
        .screen {
            display: none;
            padding-top: 60px;
            min-height: 100vh;
        }

        .screen.active {
            display: block;
        }

        /* Menu Screen */
        .menu-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
        }

        .game-title {
            font-size: 4rem;
            font-weight: bold;
            color: #FFD700;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.5);
            margin-bottom: 50px;
            line-height: 1.2;
        }

        .menu-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
        }

        .menu-btn {
            padding: 15px 30px;
            font-size: 18px;
            font-weight: bold;
            border: 3px solid #333;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 200px;
        }

        .menu-btn.play {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
        }

        .menu-btn.log {
            background: linear-gradient(45deg, #2196F3, #1976D2);
            color: white;
        }

        .menu-btn.scores {
            background: linear-gradient(45deg, #FF9800, #F57C00);
            color: white;
        }

        .menu-btn.help {
            background: linear-gradient(45deg, #9C27B0, #7B1FA2);
            color: white;
        }

        .menu-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        /* Game Screen */
        .game-screen {
            padding: 20px;
        }

        .game-message {
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            text-align: center;
            margin: 0 auto 20px;
            max-width: 600px;
            font-weight: bold;
        }

        .ai-section {
            text-align: center;
            margin-bottom: 20px;
        }

        .ai-label {
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            display: inline-block;
            margin-bottom: 10px;
        }

        .ai-cards {
            display: flex;
            justify-content: center;
            gap: 5px;
            flex-wrap: wrap;
        }

        .card-back {
            width: 60px;
            height: 84px;
            background: linear-gradient(45deg, #1e3c72, #2a5298);
            border: 2px solid #333;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #FFD700;
            font-size: 24px;
        }

        .game-area {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 30px 0;
        }

        .deck-area {
            background: rgba(139, 69, 19, 0.8);
            border: 3px solid #8B4513;
            border-radius: 50px;
            padding: 20px 40px;
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .deck, .discard {
            text-align: center;
        }

        .deck-card, .discard-card {
            width: 80px;
            height: 112px;
            border: 2px solid #333;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 5px;
            cursor: pointer;
        }

        .deck-card {
            background: linear-gradient(45deg, #1e3c72, #2a5298);
            color: #FFD700;
        }

        .discard-card {
            background: white;
            color: black;
        }

        .player-section {
            text-align: center;
        }

        .player-label {
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            display: inline-block;
            margin-bottom: 15px;
        }

        .player-cards {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            max-width: 100%;
            overflow-x: auto;
            padding: 10px;
        }

        .card {
            width: 70px;
            height: 98px;
            background: white;
            border: 2px solid #333;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            position: relative;
            flex-shrink: 0;
        }

        .card:hover {
            transform: translateY(-10px);
        }

        .card.selected {
            border-color: #FFD700;
            box-shadow: 0 0 15px #FFD700;
            transform: translateY(-15px);
        }

        .card.red {
            color: red;
        }

        .card.black {
            color: black;
        }

        .game-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .game-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .play-btn {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
        }

        .last-card-btn {
            background: linear-gradient(45deg, #9C27B0, #7B1FA2);
            color: white;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .clear-btn {
            background: linear-gradient(45deg, #FF5722, #D84315);
            color: white;
        }

        .draw-btn {
            background: linear-gradient(45deg, #2196F3, #1976D2);
            color: white;
        }

        .menu-btn-game {
            background: linear-gradient(45deg, #FF9800, #F57C00);
            color: white;
        }

        .game-btn:hover {
            transform: scale(1.05);
        }

        .game-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Log Screen */
        .log-screen {
            display: flex;
            padding: 20px;
            gap: 20px;
        }

        .log-content {
            flex: 2;
            background: black;
            border: 2px solid #00FF00;
            border-radius: 10px;
            padding: 20px;
            color: #00FF00;
            font-family: 'Courier New', monospace;
            height: 70vh;
            overflow-y: auto;
        }

        .log-title {
            color: #00FF00;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
        }

        .log-entry {
            margin-bottom: 10px;
            padding: 5px;
            border-left: 3px solid #00FF00;
            padding-left: 10px;
        }

        .log-timestamp {
            color: #888;
            font-size: 12px;
        }

        .ad-space {
            flex: 1;
            background: #f0f0f0;
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            height: 70vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .ad-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #666;
        }

        .sample-ad {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        /* Scores Screen */
        .scores-screen {
            display: flex;
            padding: 20px;
            gap: 20px;
        }

        .scores-content {
            flex: 2;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 30px;
            color: white;
        }

        .scores-title {
            font-size: 28px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 30px;
        }

        .stats-section {
            margin-bottom: 30px;
        }

        .stats-header {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
            border-bottom: 2px solid rgba(255,255,255,0.3);
            padding-bottom: 5px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .stat-item {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #FFD700;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.8;
        }

        .reset-btn {
            background: linear-gradient(45deg, #FF5722, #D84315);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 20px;
        }

        .reset-btn:hover {
            transform: scale(1.05);
        }

        /* Win Message */
        .win-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(45deg, #FFD700, #FFA500);
            color: black;
            padding: 20px 40px;
            border-radius: 15px;
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            z-index: 2000;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            max-width: 400px;
            border: 3px solid #333;
        }

        .win-close {
            position: absolute;
            top: 5px;
            right: 10px;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            font-weight: bold;
        }

        /* Penalty Counter */
        .penalty-counter {
            position: fixed;
            top: 120px;
            right: 20px;
            background: linear-gradient(45deg, #FF5722, #D84315);
            color: white;
            padding: 15px;
            border-radius: 10px;
            font-weight: bold;
            z-index: 1500;
            animation: pulse 1s infinite;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .game-title {
                font-size: 2.5rem;
            }
            
            .player-cards {
                gap: 5px;
            }
            
            .card {
                width: 60px;
                height: 84px;
            }
            
            .log-screen, .scores-screen {
                flex-direction: column;
            }
            
            .nav-buttons {
                flex-wrap: wrap;
                gap: 5px;
            }
            
            .nav-btn {
                padding: 6px 12px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <div class="nav-bar">
        <div class="nav-title">Imperial Black</div>
        <div class="nav-buttons">
            <button class="nav-btn active" onclick="showScreen('menu')">Menu</button>
            <button class="nav-btn" onclick="showScreen('game')">Game</button>
            <button class="nav-btn" onclick="showScreen('log')">Log</button>
            <button class="nav-btn" onclick="showScreen('scores')">Scores</button>
        </div>
    </div>

    <!-- Menu Screen -->
    <div id="menu-screen" class="screen active menu-screen">
        <div class="game-title">
            Backyard<br>
            Black Jack
        </div>
        <div class="menu-buttons">
            <button class="menu-btn play" onclick="startNewGame()">💎 PLAY GAME</button>
            <button class="menu-btn log" onclick="showScreen('log')">📊 GAME LOG</button>
            <button class="menu-btn scores" onclick="showScreen('scores')">🏆 SCORES</button>
            <button class="menu-btn help" onclick="showScreen('help')">📖 HOW TO PLAY</button>
        </div>
    </div>

    <!-- Game Screen -->
    <div id="game-screen" class="screen game-screen">
        <div id="game-message" class="game-message">Welcome to Imperial Black!</div>
        
        <div class="ai-section">
            <div class="ai-label">🤖 AI Player - <span id="ai-card-count">7</span> cards</div>
            <div id="ai-cards" class="ai-cards"></div>
        </div>

        <div class="game-area">
            <div class="deck-area">
                <div class="deck">
                    <div class="deck-card" onclick="drawCard()">🂠</div>
                    <div>Deck (<span id="deck-count">37</span>)</div>
                </div>
                <div class="discard">
                    <div id="discard-card" class="discard-card">🂠</div>
                    <div>Discard</div>
                </div>
            </div>
        </div>

        <div class="player-section">
            <div class="player-label">💎 Your Hand - <span id="player-card-count">7</span> cards</div>
            <div id="player-cards" class="player-cards"></div>
        </div>

        <div class="game-controls">
            <button id="play-btn" class="game-btn play-btn" onclick="playSelectedCards()" style="display: none;">🎯 Play Selected</button>
            <button id="last-card-btn" class="game-btn last-card-btn" onclick="declareLastCard()" style="display: none;">🗣️ Last Card!</button>
            <button class="game-btn clear-btn" onclick="clearSelection()">❌ Clear Selection</button>
            <button class="game-btn draw-btn" onclick="drawCard()">🃏 Draw Card</button>
            <button class="game-btn menu-btn-game" onclick="showScreen('menu')">🏠 Back to Menu</button>
        </div>
    </div>

    <!-- Log Screen -->
    <div id="log-screen" class="screen log-screen">
        <div class="log-content">
            <div class="log-title">GAME ACTION LOG</div>
            <div id="game-log"></div>
        </div>
        <div class="ad-space">
            <div class="ad-title">Advertisement Space</div>
            <div class="sample-ad">
                <h3>Sample Ad</h3>
                <p>Play More Games!</p>
                <p>Visit our game portal</p>
            </div>
            <p>Rotating ads will appear here</p>
        </div>
    </div>

    <!-- Scores Screen -->
    <div id="scores-screen" class="screen scores-screen">
        <div class="scores-content">
            <div class="scores-title">🏆 GAME STATISTICS</div>
            
            <div class="stats-section">
                <div class="stats-header">Current Session</div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="session-games">0</div>
                        <div class="stat-label">Games Played</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="session-wins">0</div>
                        <div class="stat-label">Wins</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="session-losses">0</div>
                        <div class="stat-label">Losses</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="session-winrate">0%</div>
                        <div class="stat-label">Win Rate</div>
                    </div>
                </div>
            </div>

            <div class="stats-section">
                <div class="stats-header">All Time</div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="total-games">0</div>
                        <div class="stat-label">Total Games</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="total-wins">0</div>
                        <div class="stat-label">Total Wins</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="total-losses">0</div>
                        <div class="stat-label">Total Losses</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="overall-winrate">0%</div>
                        <div class="stat-label">Overall Win Rate</div>
                    </div>
                </div>
            </div>

            <div class="stats-section">
                <div class="stats-header">Game Records</div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="fastest-win">--</div>
                        <div class="stat-label">Fastest Win</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="longest-game">--</div>
                        <div class="stat-label">Longest Game</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="best-streak">0</div>
                        <div class="stat-label">Best Streak</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="current-streak">0</div>
                        <div class="stat-label">Current Streak</div>
                    </div>
                </div>
            </div>

            <button class="reset-btn" onclick="resetStatistics()">Reset All Statistics</button>
        </div>
        <div class="ad-space">
            <div class="ad-title">Premium Features</div>
            <div class="sample-ad">
                <h3>UPGRADE NOW!</h3>
                <p>⭐ Premium Bonus</p>
                <p>🎯 Advanced Stats</p>
                <p>🎨 Custom Themes</p>
            </div>
            <p>Unlock premium features for enhanced gameplay experience</p>
        </div>
    </div>

    <!-- Help Screen -->
    <div id="help-screen" class="screen">
        <div style="padding: 20px; max-width: 800px; margin: 0 auto; background: rgba(255,255,255,0.9); border-radius: 15px; margin-top: 20px;">
            <h1>How to Play Imperial Black</h1>
            <h2>🎯 Objective</h2>
            <p><strong>Be the first player to discard all your cards!</strong></p>
            
            <h2>💎 How to Play</h2>
            <ul>
                <li>Match the <strong>suit</strong> or <strong>rank</strong> of the top card</li>
                <li>Click cards to select them (yellow glow), then click "Play Selected"</li>
                <li>Play <strong>runs</strong> - multiple cards of the same rank (any suits)</li>
                <li>Click "Last Card!" when you have one card left</li>
                <li>Click "Clear Selection" to deselect cards</li>
                <li>If you can't play, click "Draw Card"</li>
            </ul>

            <h2>💥 Power Cards</h2>
            <ul>
                <li><strong>2:</strong> Next player picks up 2 cards (stackable up to 8!)</li>
                <li><strong>Black Jack (J♠/J♣):</strong> Next player picks up 6 cards (stackable up to 24!)</li>
                <li><strong>Red Jack (J♥/J♦):</strong> Cancels Black Jack pickup (must be played immediately)</li>
                <li><strong>King:</strong> Reverses direction of play</li>
                <li><strong>8:</strong> Skips next player's turn</li>
                <li><strong>Ace:</strong> Changes suit to suit of Ace played</li>
            </ul>

            <h2>⚠️ Last Card Rule</h2>
            <p><strong>Must declare "Last Card!"</strong> when you have one card left, or pick up 2 penalty cards!</p>

            <h2>🔥 Penalty Stacking</h2>
            <p><strong>Stack penalties!</strong> Play a 2 on a 2 to make opponent pick up 4 cards! Stack Black Jacks for up to 24 cards!</p>
        </div>
    </div>

    <script>
        // Game State
        let gameState = {
            deck: [],
            playerHand: [],
            aiHand: [],
            discardPile: [],
            selectedCards: [],
            currentPlayer: 'player',
            gameStarted: false,
            penaltyCount: 0,
            penaltyType: '',
            gameStartTime: null,
            lastCardDeclared: false
        };

        // Statistics
        let stats = {
            session: { games: 0, wins: 0, losses: 0 },
            allTime: { games: 0, wins: 0, losses: 0 },
            records: { fastestWin: null, longestGame: null, bestStreak: 0, currentStreak: 0 }
        };

        // Game Log
        let gameLog = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadStatistics();
            updateStatisticsDisplay();
            showScreen('menu');
        });

        // Screen Management
        function showScreen(screenName) {
            // Hide all screens
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            
            // Update nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected screen
            document.getElementById(screenName + '-screen').classList.add('active');
            
            // Update active nav button
            event.target.classList.add('active');
            
            // Special handling for game screen
            if (screenName === 'game' && !gameState.gameStarted) {
                startNewGame();
            }
        }

        // Card Creation
        function createDeck() {
            const suits = ['♠', '♥', '♦', '♣'];
            const ranks = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
            const deck = [];
            
            for (let suit of suits) {
                for (let rank of ranks) {
                    deck.push({ rank, suit });
                }
            }
            
            return shuffleDeck(deck);
        }

        function shuffleDeck(deck) {
            for (let i = deck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [deck[i], deck[j]] = [deck[j], deck[i]];
            }
            return deck;
        }

        // Game Initialization
        function startNewGame() {
            gameState.deck = createDeck();
            gameState.playerHand = gameState.deck.splice(0, 7);
            gameState.aiHand = gameState.deck.splice(0, 7);
            gameState.discardPile = [gameState.deck.pop()];
            gameState.selectedCards = [];
            gameState.currentPlayer = 'player';
            gameState.gameStarted = true;
            gameState.penaltyCount = 0;
            gameState.penaltyType = '';
            gameState.gameStartTime = Date.now();
            gameState.lastCardDeclared = false;
            
            addToLog('Game started! Match suit or rank, or play power cards!');
            updateDisplay();
            showScreen('game');
        }

        // Display Updates
        function updateDisplay() {
            updatePlayerHand();
            updateAIHand();
            updateDiscardPile();
            updateDeckCount();
            updateGameControls();
            updateGameMessage();
        }

        function updatePlayerHand() {
            const container = document.getElementById('player-cards');
            container.innerHTML = '';
            
            gameState.playerHand.forEach((card, index) => {
                const cardElement = document.createElement('div');
                cardElement.className = `card ${card.suit === '♥' || card.suit === '♦' ? 'red' : 'black'}`;
                cardElement.innerHTML = `<div>${card.rank}</div><div>${card.suit}</div>`;
                cardElement.onclick = () => toggleCardSelection(index);
                
                if (gameState.selectedCards.includes(index)) {
                    cardElement.classList.add('selected');
                }
                
                container.appendChild(cardElement);
            });
            
            document.getElementById('player-card-count').textContent = gameState.playerHand.length;
        }

        function updateAIHand() {
            const container = document.getElementById('ai-cards');
            container.innerHTML = '';
            
            for (let i = 0; i < gameState.aiHand.length; i++) {
                const cardElement = document.createElement('div');
                cardElement.className = 'card-back';
                cardElement.innerHTML = '🂠';
                container.appendChild(cardElement);
            }
            
            document.getElementById('ai-card-count').textContent = gameState.aiHand.length;
        }

        function updateDiscardPile() {
            const topCard = gameState.discardPile[gameState.discardPile.length - 1];
            const discardElement = document.getElementById('discard-card');
            discardElement.innerHTML = `<div>${topCard.rank}</div><div>${topCard.suit}</div>`;
            discardElement.className = `discard-card ${topCard.suit === '♥' || topCard.suit === '♦' ? 'red' : 'black'}`;
        }

        function updateDeckCount() {
            document.getElementById('deck-count').textContent = gameState.deck.length;
        }

        function updateGameControls() {
            const playBtn = document.getElementById('play-btn');
            const lastCardBtn = document.getElementById('last-card-btn');
            
            // Show/hide play button
            if (gameState.selectedCards.length > 0 && gameState.currentPlayer === 'player' && gameState.penaltyCount === 0) {
                playBtn.style.display = 'inline-block';
                playBtn.textContent = `🎯 Play Selected (${gameState.selectedCards.length})`;
            } else if (gameState.selectedCards.length > 0 && gameState.penaltyCount > 0) {
                // Allow playing penalty cards during penalty
                const selectedCard = gameState.playerHand[gameState.selectedCards[0]];
                if (canStackPenalty(selectedCard)) {
                    playBtn.style.display = 'inline-block';
                    playBtn.textContent = `🎯 Play Selected (${gameState.selectedCards.length})`;
                } else {
                    playBtn.style.display = 'none';
                }
            } else {
                playBtn.style.display = 'none';
            }
            
            // Show/hide last card button
            if (gameState.playerHand.length === 1 && gameState.currentPlayer === 'player' && !gameState.lastCardDeclared) {
                lastCardBtn.style.display = 'inline-block';
            } else {
                lastCardBtn.style.display = 'none';
            }
        }

        function updateGameMessage() {
            const messageElement = document.getElementById('game-message');
            
            if (gameState.penaltyCount > 0) {
                messageElement.innerHTML = `⚠️ Penalty! Pick up ${gameState.penaltyCount} cards or play a ${gameState.penaltyType}!`;
                messageElement.style.background = 'linear-gradient(45deg, #FF5722, #D84315)';
            } else if (gameState.currentPlayer === 'ai') {
                messageElement.innerHTML = 'AI is thinking...';
                messageElement.style.background = 'rgba(0,0,0,0.8)';
            } else {
                messageElement.innerHTML = 'Your turn! Match suit or rank, or play power cards!';
                messageElement.style.background = 'rgba(0,0,0,0.8)';
            }
        }

        // Card Selection
        function toggleCardSelection(index) {
            if (gameState.currentPlayer !== 'player') return;
            
            const cardIndex = gameState.selectedCards.indexOf(index);
            if (cardIndex > -1) {
                gameState.selectedCards.splice(cardIndex, 1);
            } else {
                gameState.selectedCards.push(index);
            }
            
            updateDisplay();
        }

        function clearSelection() {
            gameState.selectedCards = [];
            updateDisplay();
        }

        // Card Playing Logic
        function playSelectedCards() {
            if (gameState.selectedCards.length === 0 || gameState.currentPlayer !== 'player') return;
            
            const selectedCards = gameState.selectedCards.map(index => gameState.playerHand[index]);
            
            if (gameState.penaltyCount > 0) {
                // Handle penalty stacking
                if (selectedCards.length === 1 && canStackPenalty(selectedCards[0])) {
                    playPenaltyStack(selectedCards[0]);
                    return;
                } else {
                    addToLog('Cannot play - must pick up penalty or play valid penalty card!');
                    return;
                }
            }
            
            if (isValidPlay(selectedCards)) {
                // Remove cards from hand
                gameState.selectedCards.sort((a, b) => b - a);
                gameState.selectedCards.forEach(index => {
                    const card = gameState.playerHand.splice(index, 1)[0];
                    gameState.discardPile.push(card);
                });
                
                const lastPlayedCard = gameState.discardPile[gameState.discardPile.length - 1];
                addToLog(`You played ${formatCards(selectedCards)}`);
                
                // Handle power cards
                handlePowerCard(lastPlayedCard, selectedCards.length > 1);
                
                gameState.selectedCards = [];
                
                // Check for win
                if (gameState.playerHand.length === 0) {
                    playerWins();
                    return;
                }
                
                // Check last card rule
                if (gameState.playerHand.length === 1 && !gameState.lastCardDeclared) {
                    addToLog('⚠️ Penalty! You must declare "Last Card!" - Picked up 2 cards!');
                    gameState.playerHand.push(gameState.deck.pop(), gameState.deck.pop());
                    gameState.lastCardDeclared = false;
                }
                
                updateDisplay();
                
                // AI turn
                setTimeout(() => {
                    if (gameState.currentPlayer === 'player') {
                        gameState.currentPlayer = 'ai';
                        aiTurn();
                    }
                }, 1000);
            } else {
                addToLog('Cannot play - cards don\'t match current selection or top card!');
            }
        }

        function isValidPlay(cards) {
            if (cards.length === 0) return false;
            
            const topCard = gameState.discardPile[gameState.discardPile.length - 1];
            
            // Check if it's a run (same rank)
            if (cards.length > 1) {
                const rank = cards[0].rank;
                return cards.every(card => card.rank === rank);
            }
            
            // Single card - check suit or rank match, or if it's an Ace (wild)
            const card = cards[0];
            return card.suit === topCard.suit || card.rank === topCard.rank || card.rank === 'A';
        }

        function canStackPenalty(card) {
            if (gameState.penaltyType === '2' && card.rank === '2') return true;
            if (gameState.penaltyType === 'Black Jack' && (card.rank === 'J' && (card.suit === '♠' || card.suit === '♣'))) return true;
            if (gameState.penaltyType === 'Black Jack' && (card.rank === 'J' && (card.suit === '♥' || card.suit === '♦'))) return true; // Red Jack cancels
            return false;
        }

        function playPenaltyStack(card) {
            gameState.playerHand.splice(gameState.selectedCards[0], 1);
            gameState.discardPile.push(card);
            gameState.selectedCards = [];
            
            if (card.rank === '2') {
                gameState.penaltyCount += 2;
                addToLog(`You played ${card.rank}${card.suit} - penalty stacked to ${gameState.penaltyCount} cards!`);
            } else if (card.rank === 'J' && (card.suit === '♠' || card.suit === '♣')) {
                gameState.penaltyCount += 6;
                addToLog(`You played ${card.rank}${card.suit} - penalty stacked to ${gameState.penaltyCount} cards!`);
            } else if (card.rank === 'J' && (card.suit === '♥' || card.suit === '♦')) {
                gameState.penaltyCount = 0;
                gameState.penaltyType = '';
                addToLog(`You played ${card.rank}${card.suit} - Red Jack cancels the penalty!`);
            }
            
            updateDisplay();
            
            setTimeout(() => {
                gameState.currentPlayer = 'ai';
                aiTurn();
            }, 1000);
        }

        // Power Card Handling
        function handlePowerCard(card, isInRun) {
            if (isInRun) return; // Power cards in runs are covered
            
            switch (card.rank) {
                case '2':
                    gameState.penaltyCount = 2;
                    gameState.penaltyType = '2';
                    addToLog(`${card.rank}${card.suit} played - next player must pick up 2 cards!`);
                    break;
                case 'J':
                    if (card.suit === '♠' || card.suit === '♣') {
                        gameState.penaltyCount = 6;
                        gameState.penaltyType = 'Black Jack';
                        addToLog(`${card.rank}${card.suit} played - Black Jack! Next player must pick up 6 cards!`);
                    }
                    break;
                case '8':
                    addToLog(`${card.rank}${card.suit} played - next player's turn is skipped!`);
                    // Skip will be handled in AI turn
                    break;
                case 'A':
                    addToLog(`${card.rank}${card.suit} played - suit changed to ${card.suit}!`);
                    break;
            }
        }

        // AI Logic
        function aiTurn() {
            if (gameState.currentPlayer !== 'ai') return;
            
            updateDisplay();
            
            setTimeout(() => {
                // Handle penalty
                if (gameState.penaltyCount > 0) {
                    // AI picks up penalty cards
                    for (let i = 0; i < gameState.penaltyCount; i++) {
                        if (gameState.deck.length > 0) {
                            gameState.aiHand.push(gameState.deck.pop());
                        }
                    }
                    addToLog(`AI picked up ${gameState.penaltyCount} cards!`);
                    gameState.penaltyCount = 0;
                    gameState.penaltyType = '';
                    gameState.currentPlayer = 'player';
                    updateDisplay();
                    return;
                }
                
                // Check for 8 skip
                const topCard = gameState.discardPile[gameState.discardPile.length - 1];
                if (topCard.rank === '8') {
                    addToLog('AI\'s turn was skipped! Your turn.');
                    gameState.currentPlayer = 'player';
                    updateDisplay();
                    return;
                }
                
                // AI plays a card
                const playableCard = findAIPlayableCard();
                if (playableCard) {
                    const cardIndex = gameState.aiHand.indexOf(playableCard);
                    gameState.aiHand.splice(cardIndex, 1);
                    gameState.discardPile.push(playableCard);
                    
                    addToLog(`AI played ${playableCard.rank}${playableCard.suit}`);
                    
                    // Handle AI power cards
                    handleAIPowerCard(playableCard);
                    
                    // Check AI win
                    if (gameState.aiHand.length === 0) {
                        aiWins();
                        return;
                    }
                } else {
                    // AI draws a card
                    if (gameState.deck.length > 0) {
                        gameState.aiHand.push(gameState.deck.pop());
                        addToLog('AI drew a card');
                    }
                }
                
                gameState.currentPlayer = 'player';
                updateDisplay();
            }, 1500);
        }

        function findAIPlayableCard() {
            const topCard = gameState.discardPile[gameState.discardPile.length - 1];
            
            // Find matching cards
            for (let card of gameState.aiHand) {
                if (card.suit === topCard.suit || card.rank === topCard.rank || card.rank === 'A') {
                    return card;
                }
            }
            
            return null;
        }

        function handleAIPowerCard(card) {
            switch (card.rank) {
                case '2':
                    gameState.penaltyCount = 2;
                    gameState.penaltyType = '2';
                    addToLog(`AI played ${card.rank}${card.suit} - You must pick up 2 cards!`);
                    break;
                case 'J':
                    if (card.suit === '♠' || card.suit === '♣') {
                        gameState.penaltyCount = 6;
                        gameState.penaltyType = 'Black Jack';
                        addToLog(`AI played ${card.rank}${card.suit} - Black Jack! You must pick up 6 cards!`);
                    }
                    break;
                case '8':
                    addToLog(`AI played ${card.rank}${card.suit} - Your turn is skipped!`);
                    setTimeout(() => {
                        gameState.currentPlayer = 'ai';
                        aiTurn();
                    }, 1000);
                    return;
                case 'A':
                    addToLog(`AI played ${card.rank}${card.suit} - Suit changed to ${card.suit}!`);
                    break;
            }
        }

        // Game Actions
        function drawCard() {
            if (gameState.currentPlayer !== 'player') return;
            
            if (gameState.penaltyCount > 0) {
                // Pick up penalty cards
                for (let i = 0; i < gameState.penaltyCount; i++) {
                    if (gameState.deck.length > 0) {
                        gameState.playerHand.push(gameState.deck.pop());
                    }
                }
                addToLog(`You picked up ${gameState.penaltyCount} penalty cards!`);
                gameState.penaltyCount = 0;
                gameState.penaltyType = '';
                
                gameState.currentPlayer = 'ai';
                updateDisplay();
                setTimeout(() => aiTurn(), 1000);
            } else {
                // Normal draw
                if (gameState.deck.length > 0) {
                    gameState.playerHand.push(gameState.deck.pop());
                    addToLog('You drew a card');
                    updateDisplay();
                }
            }
        }

        function declareLastCard() {
            if (gameState.playerHand.length === 1) {
                gameState.lastCardDeclared = true;
                addToLog('You declared "Last Card!"');
                updateDisplay();
            }
        }

        // Win Conditions
        function playerWins() {
            const gameTime = Math.floor((Date.now() - gameState.gameStartTime) / 1000);
            addToLog(`🎉 You win! Game completed in ${gameTime} seconds!`);
            
            // Update statistics
            stats.session.games++;
            stats.session.wins++;
            stats.allTime.games++;
            stats.allTime.wins++;
            stats.records.currentStreak++;
            
            if (stats.records.currentStreak > stats.records.bestStreak) {
                stats.records.bestStreak = stats.records.currentStreak;
            }
            
            if (!stats.records.fastestWin || gameTime < stats.records.fastestWin) {
                stats.records.fastestWin = gameTime;
            }
            
            saveStatistics();
            updateStatisticsDisplay();
            
            showWinMessage('🎉 YOU WIN! 🎉', `Game completed in ${gameTime} seconds!`);
        }

        function aiWins() {
            const gameTime = Math.floor((Date.now() - gameState.gameStartTime) / 1000);
            addToLog(`⚡ AI wins! Game lasted ${gameTime} seconds.`);
            
            // Update statistics
            stats.session.games++;
            stats.session.losses++;
            stats.allTime.games++;
            stats.allTime.losses++;
            stats.records.currentStreak = 0;
            
            if (!stats.records.longestGame || gameTime > stats.records.longestGame) {
                stats.records.longestGame = gameTime;
            }
            
            saveStatistics();
            updateStatisticsDisplay();
            
            showWinMessage('⚡ AI WINS! ⚡', `Game lasted ${gameTime} seconds.`);
        }

        function showWinMessage(title, subtitle) {
            const winDiv = document.createElement('div');
            winDiv.className = 'win-message';
            winDiv.innerHTML = `
                <button class="win-close" onclick="this.parentElement.remove()">×</button>
                <div>${title}</div>
                <div style="font-size: 16px; margin-top: 10px;">${subtitle}</div>
                <div style="margin-top: 15px;">
                    <button onclick="startNewGame(); this.parentElement.parentElement.remove();" style="padding: 10px 20px; margin-right: 10px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">Play Again</button>
                    <button onclick="showScreen('menu'); this.parentElement.parentElement.remove();" style="padding: 10px 20px; background: #FF9800; color: white; border: none; border-radius: 5px; cursor: pointer;">Menu</button>
                </div>
            `;
            document.body.appendChild(winDiv);
            
            // Auto-remove after 10 seconds
            setTimeout(() => {
                if (winDiv.parentElement) {
                    winDiv.remove();
                }
            }, 10000);
        }

        // Logging
        function addToLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            gameLog.push({ time: timestamp, message });
            
            // Keep only last 100 entries
            if (gameLog.length > 100) {
                gameLog.shift();
            }
            
            updateLogDisplay();
        }

        function updateLogDisplay() {
            const logContainer = document.getElementById('game-log');
            logContainer.innerHTML = '';
            
            gameLog.slice(-20).forEach(entry => {
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                logEntry.innerHTML = `
                    <div class="log-timestamp">[${entry.time}]</div>
                    <div>${entry.message}</div>
                `;
                logContainer.appendChild(logEntry);
            });
            
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // Statistics
        function updateStatisticsDisplay() {
            // Session stats
            document.getElementById('session-games').textContent = stats.session.games;
            document.getElementById('session-wins').textContent = stats.session.wins;
            document.getElementById('session-losses').textContent = stats.session.losses;
            document.getElementById('session-winrate').textContent = 
                stats.session.games > 0 ? Math.round((stats.session.wins / stats.session.games) * 100) + '%' : '0%';
            
            // All time stats
            document.getElementById('total-games').textContent = stats.allTime.games;
            document.getElementById('total-wins').textContent = stats.allTime.wins;
            document.getElementById('total-losses').textContent = stats.allTime.losses;
            document.getElementById('overall-winrate').textContent = 
                stats.allTime.games > 0 ? Math.round((stats.allTime.wins / stats.allTime.games) * 100) + '%' : '0%';
            
            // Records
            document.getElementById('fastest-win').textContent = 
                stats.records.fastestWin ? stats.records.fastestWin + 's' : '--';
            document.getElementById('longest-game').textContent = 
                stats.records.longestGame ? stats.records.longestGame + 's' : '--';
            document.getElementById('best-streak').textContent = stats.records.bestStreak;
            document.getElementById('current-streak').textContent = stats.records.currentStreak;
        }

        function saveStatistics() {
            localStorage.setItem('imperialBlackStats', JSON.stringify(stats));
        }

        function loadStatistics() {
            const saved = localStorage.getItem('imperialBlackStats');
            if (saved) {
                stats = JSON.parse(saved);
            }
        }

        function resetStatistics() {
            if (confirm('Are you sure you want to reset all statistics? This cannot be undone.')) {
                stats = {
                    session: { games: 0, wins: 0, losses: 0 },
                    allTime: { games: 0, wins: 0, losses: 0 },
                    records: { fastestWin: null, longestGame: null, bestStreak: 0, currentStreak: 0 }
                };
                saveStatistics();
                updateStatisticsDisplay();
                addToLog('All statistics have been reset!');
            }
        }

        // Utility Functions
        function formatCards(cards) {
            return cards.map(card => `${card.rank}${card.suit}`).join(', ');
        }
    </script>
</body>
</html>
